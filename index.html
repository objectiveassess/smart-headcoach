<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ì¡°ê¸°ì¶•êµ¬ 4ì¿¼í„° ìë™ ë°°ì • (ë°°í¬ìš©)</title>
<style>
  :root{--bg:#0b1622;--panel:rgba(255,255,255,0.04);--accent:#00c896;--muted:#a8cfc0;}
  body{font-family:Inter, 'Noto Sans KR',system-ui,Arial; background:var(--bg); color:#f0f6fc; margin:0;padding:18px;}
  .wrap{max-width:1100px;margin:0 auto;}
  h1{color:var(--accent); text-align:center;}
  .flex{display:flex;gap:8px;align-items:center;}
  .controls{display:flex;gap:8px;flex-wrap:wrap; margin:12px 0;}
  input,select,button{padding:8px;border-radius:8px;border:none;}
  input,select{background:#0f1a24;color:#fff;}
  button{background:var(--accent);color:#061017; font-weight:700; cursor:pointer;}
  button.secondary{background:#2b3b3d;color:#fff;}
  .panel{background:var(--panel);padding:12px;border-radius:10px;margin-bottom:12px;}
  .player-row{display:flex;gap:8px;align-items:center;margin-bottom:6px;}
  .player-row input{width:28%;}
  .player-row select{width:22%;}
  .player-row .del{background:#ff6b6b;color:#fff;padding:6px;border-radius:8px;}
  .result{margin-top:10px;}
  .quarter{background:rgba(255,255,255,0.03);padding:10px;border-radius:8px;margin-bottom:10px;}
  table{width:100%;border-collapse:collapse;font-size:14px;}
  th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.06);text-align:left;}
  .bar-bg{background:rgba(255,255,255,0.06);border-radius:6px; height:14px; width:100%;}
  .bar{height:14px;background:var(--accent);border-radius:6px; width:0%; transition:width .6s ease;}
  .footer-note{color:var(--muted);font-size:13px;margin-top:10px;}
  #ad {position:fixed;left:50%;top:45%;transform:translate(-50%,-50%);background:#fff;color:#061017;padding:20px 26px;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,.6);display:none;z-index:999;}
  #ad button{margin-top:10px;}
  .small{font-size:13px;color:var(--muted);}
  .left-col{width:48%;float:left}
  .right-col{width:48%;float:right}
  @media(max-width:980px){.left-col,.right-col{width:100%;float:none}}
</style>
</head>
<body>
<div class="wrap">
  <h1>âš½ ì¡°ê¸°ì¶•êµ¬ 4ì¿¼í„° ìë™ ë°°ì • (Diamond 4-4-2)</h1>

  <div class="panel">
    <div class="flex" style="justify-content:space-between;align-items:center;">
      <div class="small">ì„ ìˆ˜ ì…ë ¥ â†’ ì´ë¦„ + 1ìˆœìœ„(í•„ìˆ˜) + 2ìˆœìœ„(ì„ íƒ)</div>
      <div>
        <button onclick="addPlayerRow()">+ ì„ ìˆ˜ ì¶”ê°€</button>
        <button class="secondary" onclick="resetSample()">ì´ˆê¸° ìƒ˜í”Œ ë¶ˆëŸ¬ì˜¤ê¸°</button>
      </div>
    </div>

    <div id="player-list" style="margin-top:12px;"></div>
    <div class="small" style="margin-top:8px;color:var(--muted)">
      * ìµœì†Œ 11ëª… ì´ìƒ í•„ìš” (GK í¬í•¨). GKëŠ” pos1 ë˜ëŠ” pos2ì— 'GK' ì…ë ¥.
    </div>
  </div>

  <div class="controls">
    <button onclick="generateSchedule()">âœ… í¬ë©”ì´ì…˜ ìƒì„±</button>
    <button onclick="regenerate()">ğŸ” ë‹¤ì‹œ ì‹œë„ (ìƒˆ ì¡°í•©)</button>
    <button onclick="downloadTxt()">ğŸ’¾ ì €ì¥ (txt)</button>
  </div>

  <div id="result" class="result"></div>

  <div class="panel footer-note">
    ë°°í¬ìš© ìƒ˜í”Œ ë²„ì „ì…ë‹ˆë‹¤. ì„œë¹„ìŠ¤ ìš´ì˜ ì „ ê°œì¸ì •ë³´Â·ê´‘ê³ Â·ì €ì‘ê¶Œ ê´€ë ¨ ì •ì±…ì„ ë°˜ë“œì‹œ ê²€í† í•˜ì„¸ìš”.
  </div>
</div>

<!-- ê´‘ê³  íŒì—… -->
<div id="ad">
  <h3>Itâ€™s okay though</h3>
  <div style="font-weight:700;margin-top:6px">- ë„ì‚¬ì»´í¼ë‹ˆ</div>
  <div style="margin-top:8px">
    <button onclick="hideAd()">ë‹«ê¸°</button>
  </div>
</div>

<script>
/* -------------------------
  í¬ì§€ì…˜ ìœ ì‚¬ì„± (ë‹¨ë°©í–¥ ê·œì¹™)
  ë°˜ì˜í•œ ë§µ (ìš”ì²­ì‚¬í•­ ê¸°ë°˜)
----------------------------*/
const SIMILAR = {
  GK: [],
  CB: ['RB','LB'],
  RB: [],          // RB->CB ë¶ˆê°€
  LB: [],          // LB->CB ë¶ˆê°€
  CDM: ['CM'],
  CM: ['RM','LM'],
  CAM: ['CM'],
  RM: ['CM'],
  LM: ['CM'],
  RW: ['ST'],
  LW: ['ST'],
  ST: ['RW','LW']
};

/* ---------- UI: ì„ ìˆ˜ ì…ë ¥ í–‰ ê´€ë¦¬ ---------- */
function createPlayerRow(pref){
  const container = document.getElementById('player-list');
  const div = document.createElement('div');
  div.className = 'player-row';
  div.innerHTML = `
    <input class="pname" placeholder="ì´ë¦„" value="${pref?.name||''}">
    <select class="ppos1">
      <option value="">1ìˆœìœ„ í¬ì§€ì…˜</option>
      <option>GK</option><option>CB</option><option>RB</option><option>LB</option>
      <option>CDM</option><option>CM</option><option>CAM</option>
      <option>RM</option><option>LM</option>
      <option>RW</option><option>LW</option>
      <option>ST</option>
    </select>
    <select class="ppos2">
      <option value="">2ìˆœìœ„ í¬ì§€ì…˜</option>
      <option>GK</option><option>CB</option><option>RB</option><option>LB</option>
      <option>CDM</option><option>CM</option><option>CAM</option>
      <option>RM</option><option>LM</option>
      <option>RW</option><option>LW</option>
      <option>ST</option>
    </select>
    <button class="del" title="ì‚­ì œ">ì‚­ì œ</button>
  `;
  container.appendChild(div);
  if(pref){
    div.querySelector('.ppos1').value = pref.pos1||'';
    div.querySelector('.ppos2').value = pref.pos2||'';
  }
  div.querySelector('.del').addEventListener('click', ()=>div.remove());
  return div;
}
function addPlayerRow(){ createPlayerRow(); }

/* ì´ˆê¸° ìƒ˜í”Œ */
const SAMPLE = [
  {name:'ë„ìœ¤',pos1:'GK'},{name:'ì¤€í˜¸',pos1:'CB'},{name:'ì˜í˜¸',pos1:'LB',pos2:'CB'},
  {name:'ì§„ìš°',pos1:'RB'},{name:'ì² ìˆ˜',pos1:'CDM'},{name:'ê¸°í›ˆ',pos1:'CM'},
  {name:'í˜„ìˆ˜',pos1:'CAM'},{name:'ìƒë¯¼',pos1:'RW',pos2:'ST'},{name:'íƒœí˜¸',pos1:'ST'},
  {name:'ë¯¼ìˆ˜',pos1:'ST',pos2:'CAM'},{name:'ì„±ë¯¼',pos1:'LM'},{name:'í˜¸ì˜',pos1:'RM'},
  {name:'ì¬í˜„',pos1:'CB'},{name:'ìˆ˜ê°•',pos1:'LB'},{name:'ì°½ë¯¼',pos1:'RB'},{name:'ì¤€ì„œ',pos1:'CM'},
  {name:'ëª…ìˆ˜',pos1:'CDM'},{name:'ë„í˜„',pos1:'LW'}
];
function resetSample(){ document.getElementById('player-list').innerHTML=''; SAMPLE.forEach(p=>createPlayerRow(p)); }
resetSample();

/* ---------- ì•Œê³ ë¦¬ì¦˜ ì„¤ì • ---------- */
const TOTAL_FIELD_SLOTS = 40; // 4ì¿¼í„° * 10ë¹„GK
const MAX_CONSEC = 2;         // ì—°ì† ìµœëŒ€ 2ì¿¼í„° (3ì—°ì† ê¸ˆì§€)
const ATTEMPTS = 120;         // ì‹œë„ ìˆ˜ (í•„ìš”í•˜ë©´ ëŠ˜ë¦¬ì„¸ìš”)

/* ---------- ì „ì—­ ì €ì¥: ìµœì  ì¡°í•© ìœ ì§€/ê°±ì‹  ---------- */
let bestGlobal = {score:-Infinity, quarters:null, counts:null};

/* ---------- í—¬í¼: í˜„ì¬ UIì—ì„œ ì„ ìˆ˜ ëª©ë¡ ì½ê¸° ---------- */
function readPlayersFromUI(){
  const rows = Array.from(document.querySelectorAll('.player-row'));
  const arr = [];
  for(const r of rows){
    const name = r.querySelector('.pname').value.trim();
    const pos1 = r.querySelector('.ppos1').value;
    const pos2 = r.querySelector('.ppos2').value;
    if(!name) continue;
    arr.push({name, pos1:pos1||'', pos2:pos2||'', assigned:0, lastQ:-5, consec:0});
  }
  return arr;
}

/* ---------- ëª©í‘œ ë¶„ë°°: ê° í•„ë“œí”Œë ˆì´ì–´(targetCounts) ê³„ì‚° ---------- */
function computeTargets(fieldPlayers){
  const M = fieldPlayers.length;
  // feasible if 2*M <= 40 <= 3*M
  if(2*M <= TOTAL_FIELD_SLOTS && TOTAL_FIELD_SLOTS <= 3*M){
    // ê¸°ë³¸ 2ì¿¼í„° ë°°ì •, ë‚¨ëŠ” ìŠ¬ë¡¯ì„ 1ì”© ë‚˜ëˆ” (ìµœëŒ€ +1)
    const targets = {};
    fieldPlayers.forEach(p=>targets[p.name]=2);
    let rem = TOTAL_FIELD_SLOTS - 2*M; // 0..M
    // distribute fairly: prefer those with pos1 more usable (but we'll randomize tie)
    const order = [...fieldPlayers].sort(()=>Math.random()-0.5);
    let idx=0;
    while(rem>0){
      const name=order[idx].name;
      if(targets[name]<3){ targets[name]++; rem--; }
      idx=(idx+1)%order.length;
    }
    return targets;
  } else {
    // ë¶ˆê°€í”¼í•œ ê²½ìš°: í‰íƒ„í•˜ê²Œ floor/ceil ë¶„ë°°
    const base = Math.floor(TOTAL_FIELD_SLOTS / M);
    const extra = TOTAL_FIELD_SLOTS - base*M;
    const out = {};
    const order = [...fieldPlayers].sort(()=>Math.random()-0.5);
    for(let i=0;i<M;i++) out[order[i].name]=base + (i<extra?1:0);
    return out;
  }
}

/* ---------- í›„ë³´ ì„ íƒ ìš°ì„ ìˆœìœ„ í•¨ìˆ˜ ----------
   pos: target position string
   pool: array of player objects (mutable)
   constraints: object with current q, targets, chosenThisQuarter map
-------------------------------------------------- */
function pickCandidateForPos(pos, pool, q, targets, chosenThisQuarter){
  // Helper: check if picking p would violate rules (over target or cause 3-consec)
  const canPick = (p) => {
    if(p.assigned >= targets[p.name]) return false; // already reached target
    // avoid 3 consecutive: if p.lastQ === q-1 and p.consec >= MAX_CONSEC -> cannot pick
    if(p.lastQ === q-1 && p.consec >= MAX_CONSEC) return false;
    // avoid picking same player twice in same quarter
    if(chosenThisQuarter.has(p.name)) return false;
    return true;
  };

  // 1) search pos1 match (1ìˆœìœ„) first
  let cand = pool.find(p => canPick(p) && p.pos1 === pos);
  if(cand) return cand;
  // 2) pos2 match
  cand = pool.find(p => canPick(p) && p.pos2 === pos);
  if(cand) return cand;
  // 3) similar mapping (directional)
  cand = pool.find(p => canPick(p) && ((SIMILAR[p.pos1]||[]).includes(pos) || (SIMILAR[p.pos2]||[]).includes(pos)));
  if(cand) return cand;
  // 4) fallback: any who still needs slots
  cand = pool.find(p => canPick(p));
  return cand || null;
}

/* ---------- ì‹œë„(ëœë¤ ê¸°ë°˜)ë¡œ ë¶„ë°° ì‹œë„ ---------- */
function attemptScheduling(allPlayers, targets){
  // deep clone player state for this attempt
  const pool = allPlayers.map(p => ({...p, assigned:0, lastQ:-5, consec:0}));
  const quarters = [[],[],[],[]];
  const positionOrder = ['GK','LB','CB','CB','RB','CDM','CM','CM','CAM','ST','ST']; // canonical assignments per quarter

  // Place GK first: choose the player with pos1==='GK' or pos2==='GK' (pos1 priority)
  const gk = pool.find(p=>p.pos1==='GK') || pool.find(p=>p.pos2==='GK');
  if(!gk) return null;
  // ensure gk allocated 4 and removed from field pool (but keep in pool for counts)
  gk.assigned = 4;
  gk.lastQ = 0;
  gk.consec = 0;

  // For each quarter
  for(let q=0;q<4;q++){
    const chosenThisQuarter = new Set();
    // add GK
    quarters[q].push({pos:'GK', name:gk.name});
    // For each position in positionOrder (excluding the already filled GK)
    for(const pos of positionOrder.slice(1)){
      // heuristics: shuffle pool order for fairness
      pool.sort(()=>Math.random()-0.5);
      const candidate = pickCandidateForPos(pos, pool, q, targets, chosenThisQuarter);
      if(!candidate){
        // fail this attempt if no candidate available for required pos
        return null;
      }
      // assign
      quarters[q].push({pos, name:candidate.name});
      candidate.assigned++;
      // update consecutive tracking
      if(candidate.lastQ === q-1) candidate.consec = candidate.consec + 1;
      else candidate.consec = 1;
      candidate.lastQ = q;
      chosenThisQuarter.add(candidate.name);
    }
  }

  // After filling quarters, verify each player's assigned count equals targets (except GK may be 4)
  const unmet = pool.filter(p => p.name !== gk.name && p.assigned !== targets[p.name]);
  if(unmet.length > 0){
    // some players didn't meet targets â†’ this attempt invalid
    return null;
  }

  // compute score (prefer more pos1 matches, then pos2, then similar)
  let score = 0;
  quarters.forEach((qarr) => {
    qarr.forEach(entry => {
      if(entry.pos==='GK'){ score += 2; return; }
      const orig = allPlayers.find(x=>x.name===entry.name);
      if(!orig) return;
      if(orig.pos1 === entry.pos) score += 3;
      else if(orig.pos2 === entry.pos) score += 2;
      else if((SIMILAR[orig.pos1]||[]).includes(entry.pos) || (SIMILAR[orig.pos2]||[]).includes(entry.pos)) score += 1;
    });
  });

  // return successful schedule
  const counts = Object.fromEntries(pool.map(p=>[p.name,p.assigned]));
  return {quarters, score, counts};
}

/* ---------- ë©”ì¸: ìƒì„± í•¨ìˆ˜ ---------- */
function generateSchedule(){
  bestGlobal = {score:-Infinity, quarters:null, counts:null}; // reset best (optionally persist)
  const allPlayers = readPlayersFromUI();
  if(allPlayers.length < 11){ alert('ì„ ìˆ˜ë¥¼ 11ëª… ì´ìƒ ì…ë ¥í•˜ì„¸ìš”.'); return; }

  // find GK existence
  const gkCandidate = allPlayers.find(p=>p.pos1==='GK') || allPlayers.find(p=>p.pos2==='GK');
  if(!gkCandidate){ alert('ê³¨í‚¤í¼(GK)ê°€ 1ëª… ì´ìƒ í•„ìš”í•©ë‹ˆë‹¤ (pos1 ë˜ëŠ” pos2ì— GK ì…ë ¥).'); return; }

  // field players = excluding chosen GK slot (we still keep GK in list for display)
  const fieldPlayers = allPlayers.filter(p => !(p.pos1==='GK' || p.pos2==='GK')).length === allPlayers.length ? allPlayers.filter(p=>p.name!==gkCandidate.name) : allPlayers.filter(p=>!(p.name===gkCandidate.name));

  // compute targets (field only)
  const fieldList = allPlayers.filter(p=>!(p.pos1==='GK'||p.pos2==='GK' || p.name===gkCandidate.name));
  const targets = computeTargets(fieldList);

  // Ensure GK has assigned 4 separately (we remove GK from target map)
  // Run multiple attempts (randomized) to find valid schedule
  let bestAttempt = null;
  for(let i=0;i<ATTEMPTS;i++){
    const attempt = attemptScheduling(allPlayers, targets);
    if(attempt && attempt.score > (bestAttempt?.score||-Infinity)){
      bestAttempt = attempt;
      // early break if perfect high score (optional)
      if(attempt.score === (4*11*3)) break;
    }
  }

  if(!bestAttempt){
    alert('ìœ íš¨í•œ ë°°ì •ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì„ ìˆ˜ ìˆ˜/í¬ì§€ì…˜ì„ ì¡°ì •í•˜ê±°ë‚˜ ì‹œë„ ìˆ˜(ATTEMPTS)ë¥¼ ëŠ˜ë¦¬ì„¸ìš”.');
    return;
  }

  // update global best if better
  if(bestAttempt.score >= bestGlobal.score){
    bestGlobal = {score:bestAttempt.score, quarters:bestAttempt.quarters, counts:bestAttempt.counts};
  }

  // render result
  renderResult(bestGlobal.quarters, bestGlobal.counts, bestGlobal.score);
}

/* ---------- ì¬ì‹œë„ ë²„íŠ¼: ë‹¤ì‹œ ì‹œë„(ìƒˆ ëœë¤ ì¡°í•©) ---------- */
function regenerate(){
  // use current UI players and recompute (preserve previous bestGlobal also)
  const allPlayers = readPlayersFromUI();
  if(allPlayers.length < 11){ alert('ì„ ìˆ˜ë¥¼ 11ëª… ì´ìƒ ì…ë ¥í•˜ì„¸ìš”.'); return; }
  const fieldList = allPlayers.filter(p=>!(p.pos1==='GK'||p.pos2==='GK' || (allPlayers.find(x=>x.pos1==='GK' || x.pos2==='GK')?.name === p.name)));
  const targets = computeTargets(fieldList);

  // Try attempts and update bestGlobal only if we find better
  let bestAttempt = null;
  for(let i=0;i<ATTEMPTS;i++){
    const attempt = attemptScheduling(allPlayers, targets);
    if(attempt && (!bestAttempt || attempt.score > bestAttempt.score)) bestAttempt = attempt;
  }
  if(!bestAttempt){ alert('ìƒˆ ì¡°í•©ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.'); return; }
  if(bestAttempt.score >= bestGlobal.score){
    bestGlobal = {score:bestAttempt.score, quarters:bestAttempt.quarters, counts:bestAttempt.counts};
  }
  renderResult(bestGlobal.quarters, bestGlobal.counts, bestGlobal.score);
}

/* ---------- ë Œë”ë§ í•¨ìˆ˜ ---------- */
function renderResult(quarters, counts, score){
  const out = document.getElementById('result');
  let html = `<div class="panel"><div style="display:flex;justify-content:space-between;align-items:center;"><div><strong>ìµœì  ì ìˆ˜:</strong> ${score}</div><div class="small">(ë†’ì„ìˆ˜ë¡ 1ìˆœìœ„Â·2ìˆœìœ„ ìš°ì„  ë°˜ì˜)</div></div></div>`;

  for(let q=0;q<4;q++){
    html += `<div class="quarter"><h3>ğŸ•’ ${q+1}ì¿¼í„°</h3><table><tr><th>í¬ì§€ì…˜</th><th>ì„ ìˆ˜</th></tr>`;
    if(!quarters || !quarters[q]){ html += `<tr><td colspan="2">ë°°ì • ì—†ìŒ</td></tr></table></div>`; continue; }
    // ensure 11 printed (it should be)
    quarters[q].forEach(entry => {
      html += `<tr><td>${entry.pos}</td><td>${entry.name}</td></tr>`;
    });
    html += `</table></div>`;
  }

  // summary table with bars
  html += `<div class="panel"><h3>âš–ï¸ ì¶œì „ ì¿¼í„° ìš”ì•½</h3><table><tr><th>ì´ë¦„</th><th>ì¿¼í„° ìˆ˜</th><th>ê·¸ë˜í”„</th></tr>`;
  const sorted = Object.keys(counts).sort((a,b)=>counts[b]-counts[a]||a.localeCompare(b));
  sorted.forEach(name=>{
    const c = counts[name];
    const pct = Math.round((c/4)*100);
    html += `<tr><td>${name}</td><td>${c}</td><td><div class="bar-bg"><div class="bar" style="width:${pct}%;"></div></div></td></tr>`;
  });
  html += `</table></div>`;
  out.innerHTML = html;
  // animate bars (they already have transition)
  setTimeout(()=>{ document.querySelectorAll('.bar').forEach(b=>b.style.width=b.style.width); }, 50);
}

/* ---------- ìœ í‹¸: ì €ì¥ ---------- */
function downloadTxt(){
  if(!bestGlobal.quarters){ alert('ë¨¼ì € í¬ë©”ì´ì…˜ì„ ìƒì„±í•˜ì„¸ìš”.'); return; }
  let txt = `í¬ë©”ì´ì…˜ (ìµœì  ì ìˆ˜: ${bestGlobal.score})\n\n`;
  bestGlobal.quarters.forEach((q,i)=>{
    txt+= `${i+1}ì¿¼í„°:\n`;
    q.forEach(e=>txt+= `${e.pos}: ${e.name}\n`);
    txt += '\n';
  });
  const blob = new Blob([txt],{type:'text/plain'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'formation.txt';
  document.body.appendChild(a); a.click(); a.remove();
}

/* ---------- ê´‘ê³  íŒì—… ì œì–´ (í•œ ë²ˆë§Œ ìë™ í‘œì‹œ) ---------- */
function hideAd(){ document.getElementById('ad').style.display='none'; }
(function(){ if(!localStorage.getItem('ad_shown')){ setTimeout(()=>{ document.getElementById('ad').style.display='block'; localStorage.setItem('ad_shown','1'); },3000); } })();

</script>
</body>
</html>
