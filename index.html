<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>âš½ ì¡°ê¸°ì¶•êµ¬ 4-4-2 ìë™ ë°°ì • (ìƒìš©ìš©)</title>
<style>
:root{
  --bg:#0b1622; --panel:rgba(255,255,255,0.04); --accent:#00c896; --muted:#9fdac8;
}
html,body{height:100%;}
body{
  font-family: "Noto Sans KR",system-ui,Arial;
  background:var(--bg); color:#f0f6fc; margin:0; padding:18px;
}
.wrap{max-width:1150px;margin:0 auto;}
.header{display:flex;justify-content:space-between;align-items:center;gap:12px;}
h1{color:var(--accent);margin:0;font-size:20px;}
.small{font-size:13px;color:var(--muted);}
.panel{background:var(--panel);padding:12px;border-radius:10px;margin-top:12px;}
.controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;}
input,select,button{padding:8px;border-radius:8px;border:none;font-size:14px;}
input,select{background:#0f1a24;color:#fff;}
button{background:var(--accent);color:#081217;font-weight:700;cursor:pointer;}
button.secondary{background:#2b3b3d;color:#fff;}
.player-row{display:flex;gap:8px;align-items:center;margin-bottom:8px;}
.player-row input{width:30%;}
.player-row select{width:25%;}
.player-row .del{background:#ff6b6b;color:#fff;padding:8px;border-radius:8px;cursor:pointer;}
.flex-sb{display:flex;justify-content:space-between;align-items:center;}
.result{margin-top:12px;}
.quarter{background:rgba(255,255,255,0.03);padding:10px;border-radius:8px;margin-bottom:10px;}
.table{width:100%;border-collapse:collapse;}
.table th,.table td{padding:8px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.06);}
.bar-bg{background:rgba(255,255,255,0.06);border-radius:6px;height:14px;width:100%;}
.bar{height:14px;background:var(--accent);border-radius:6px;width:0%;transition:width .7s ease;}
.notice{color:#ffd066;font-size:13px;margin-top:8px;}
.footer{margin-top:15px;color:var(--muted);font-size:13px;}
#ad-popup{position:fixed;left:50%;top:48%;transform:translate(-50%,-50%);background:#0f1720;padding:20px;border-radius:10px;box-shadow:0 10px 40px rgba(0,0,0,0.6);display:none;z-index:9999;border:2px solid #58a6ff;}
#ad-popup h2{margin:0;color:#fff;}
.download-link{background:#2b3b3d;color:#fff;padding:8px;border-radius:8px;}
@media(max-width:900px){
  .player-row input{width:36%;}
  .player-row select{width:28%;}
}
</style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <h1>âš½ ì¡°ê¸°ì¶•êµ¬ 4-4-2 ìë™ ë°°ì • (ìƒìš©ìš©)</h1>
    <div class="small">ì²˜ìŒ ì‚¬ìš© ì „ ìƒ˜í”Œ ë¶ˆëŸ¬ì˜¤ê¸° í›„ í…ŒìŠ¤íŠ¸í•˜ì„¸ìš”. ìš´ì˜ ì „ ê°œì¸ì •ë³´Â·ê´‘ê³  ì •ì±… ê²€í†  í•„ìˆ˜.</div>
  </div>

  <div class="panel">
    <div class="flex-sb">
      <div>
        <button onclick="addPlayerRow()">+ ì„ ìˆ˜ ì¶”ê°€</button>
        <button class="secondary" onclick="loadSample()">ìƒ˜í”Œ ë¶ˆëŸ¬ì˜¤ê¸°</button>
        <button class="secondary" onclick="clearAll()">ì´ˆê¸°í™”</button>
      </div>
      <div class="small">í¬ì§€ì…˜ ëª©ë¡: GK, CB, RB, LB, CDM, CM, RM, LM, CAM, LW, RW, ST</div>
    </div>

    <div id="player-list" style="margin-top:12px;"></div>
    <div class="notice" id="warning" style="display:none;"></div>
  </div>

  <div class="controls">
    <button onclick="generateSchedule()">âœ… í¬ë©”ì´ì…˜ ìƒì„±</button>
    <button onclick="regenerate()">ğŸ” ë‹¤ì‹œ ì‹œë„ (ìƒˆ ì¡°í•©)</button>
    <button onclick="exportTxt()" class="download-link">ğŸ’¾ í…ìŠ¤íŠ¸ë¡œ ì €ì¥</button>
    <label style="display:flex;align-items:center;gap:8px;color:var(--muted);font-size:13px;">
      ì‹œë„ ìˆ˜:
      <input id="attempts" type="number" value="400" min="50" max="5000" style="width:90px;padding:6px;border-radius:8px;">
    </label>
  </div>

  <div id="result" class="result"></div>

  <div class="panel footer">
    <strong>ì£¼ì˜</strong>: ì´ ë„êµ¬ëŠ” ìë™ ë°°ì • ë³´ì¡° ë„êµ¬ì…ë‹ˆë‹¤. ì‹¤ì œ ì„œë¹„ìŠ¤ ë°°í¬ ì „ ê°œì¸ì •ë³´, ê´‘ê³ /í”„ë¡œëª¨ì…˜ ê·œì •, ì‚¬ìš©ì ë™ì˜, ë¡œê·¸ ë³´ê´€ ì •ì±… ë“±ì„ ë°˜ë“œì‹œ ê²€í† í•˜ê³  ë²•ë¥  ìë¬¸ì„ ë°›ìœ¼ì„¸ìš”.
  </div>
</div>

<!-- ê´‘ê³  íŒì—… (í•œ ë²ˆë§Œ ìë™ í‘œì‹œ) -->
<div id="ad-popup" role="dialog" aria-hidden="true">
  <h2>Itâ€™s okay though</h2>
  <div style="margin-top:8px;font-weight:700;color:#dfffe0">- ë„ì‚¬ì»´í¼ë‹ˆ</div>
  <div style="margin-top:12px"><button onclick="hideAd()">ë‹«ê¸°</button></div>
</div>

<script>
/*
  ìµœì¢… ìƒìš© ë²„ì „ (index.html, inline JS)
  - 1ìˆœìœ„ ìš°ì„  ë°°ì •, 2ìˆœìœ„ ë³´ì¡°, í˜¸í™˜ í¬ì§€ì…˜ ë°˜ì˜
  - ëª¨ë“  ì„ ìˆ˜ ìµœì†Œ 2ì¿¼í„°, ìµœëŒ€ 3ì¿¼í„° (í•„ë“œ ì´ ìŠ¬ë¡¯ 40)
  - 3ì¿¼í„° ì—°ì† ì¶œì „ ê¸ˆì§€ (ìµœëŒ€ ì—°ì† 2ì¿¼í„°)
  - ì¿¼í„°ë‹¹ ì •í™•íˆ 11ëª… (GK í¬í•¨)
  - ì¬ì‹œë„(ëœë¤)ë¡œ ìµœì  ì¡°í•© ì„ íƒ(ì ìˆ˜ ê¸°ì¤€)
  - íŒì—… ê´‘ê³  1íšŒ ìë™ í‘œì‹œ
  - ì„ ìˆ˜ ì¶”ê°€/ì‚­ì œ UI
*/

/* ---------- í¬ì§€ì…˜ í˜¸í™˜ ê·œì¹™ (ë„ˆê°€ ì§€ì •í•œ ë°©í–¥ì„± ê·¸ëŒ€ë¡œ) ---------- */
const COMPATIBLE = {
  GK: ["GK"],
  CB: ["CB","RB","LB"],   // CBì€ RB/LBë„ ê°€ëŠ¥
  RB: ["RB"],            // RBëŠ” CB ë¶ˆê°€
  LB: ["LB"],            // LBëŠ” CB ë¶ˆê°€
  CDM: ["CDM","CM"],     // CDMì€ CM ê°€ëŠ¥
  CM: ["CM","RM","LM"],  // CMì€ RM/LM ê°€ëŠ¥
  RM: ["RM","CM"],
  LM: ["LM","CM"],
  CAM: ["CAM","CM"],     // CAMì€ CMìœ¼ë¡œ ì‚¬ìš© ê°€ëŠ¥ (CDM ë¶ˆê°€)
  LW: ["LW","ST"],       // LW/RWëŠ” STë¡œë„ ê°€ëŠ¥
  RW: ["RW","ST"],
  ST: ["ST","LW","RW"]
};

/* ---------- í¬ì§€ì…˜ ìŠ¬ë¡¯ (ë‹¤ì´ì•„ëª¬ë“œ 4-4-2) ---------- */
/* ì¿¼í„°ë‹¹ 11ëª…: GK(1) + í•„ë“œ 10ëª… (LB,CB,CB,RB, CDM,CM,CM,CAM, ST,ST) */
const POSITIONS = ["GK","LB","CB","CB","RB","CDM","CM","CM","CAM","ST","ST"];
const TOTAL_FIELD_SLOTS = 40; // 4ì¿¼í„° * 10field
const MAX_CONSEC = 2; // ì—°ì† ìµœëŒ€ 2ì¿¼í„° (3ì—°ì† ê¸ˆì§€)

/* ---------- UI: ì„ ìˆ˜ í–‰ ìƒì„±/ê´€ë¦¬ ---------- */
function createPlayerRow(pref){
  const list = document.getElementById('player-list');
  const div = document.createElement('div');
  div.className = 'player-row';
  div.innerHTML = `
    <input class="pname" placeholder="ì´ë¦„" value="${pref?.name||''}">
    <select class="ppos1">
      <option value="">1ìˆœìœ„ í¬ì§€ì…˜</option>
      <option>GK</option><option>CB</option><option>RB</option><option>LB</option>
      <option>CDM</option><option>CM</option><option>RM</option><option>LM</option>
      <option>CAM</option><option>LW</option><option>RW</option><option>ST</option>
    </select>
    <select class="ppos2">
      <option value="">2ìˆœìœ„ í¬ì§€ì…˜</option>
      <option>GK</option><option>CB</option><option>RB</option><option>LB</option>
      <option>CDM</option><option>CM</option><option>RM</option><option>LM</option>
      <option>CAM</option><option>LW</option><option>RW</option><option>ST</option>
    </select>
    <button class="del">ì‚­ì œ</button>
  `;
  list.appendChild(div);
  if(pref){
    div.querySelector('.ppos1').value = pref.pos1||'';
    div.querySelector('.ppos2').value = pref.pos2||'';
  }
  div.querySelector('.del').addEventListener('click', ()=>div.remove());
  return div;
}
function addPlayerRow(){ createPlayerRow(); }
function loadSample(){
  const SAMPLE = [
    {name:'ìŠ¹í˜„',pos1:'GK'},
    {name:'ë„í˜„',pos1:'ST',pos2:'RW'},
    {name:'êµ°íƒ',pos1:'LB',pos2:'CDM'},
    {name:'ë„í›ˆ',pos1:'RB',pos2:'LB'},
    {name:'ìŠ¹ì¬',pos1:'CDM', pos2:'CB'},
    {name:'ì¬ê¸°',pos1:'CAM',pos2:'LW'},
    {name:'ì¤€í™',pos1:'CAM',pos2:'ST'},
    {name:'í˜•íƒœ',pos1:'CM',pos2:'CB'},
    {name:'ê¹€ì˜ìš±',pos1:'ST',pos2:'LW'},
    {name:'ì •ì¤€',pos1:'CB',pos2:'CM'},
    {name:'ìš°ì„±',pos1:'RB',pos2:'RW'},
    {name:'í˜¸ì •',pos1:'RB',pos2:'CB'},
    {name:'í›„ì•ˆ',pos1:'CAM',pos2:'CM'},
    {name:'ì°¬',pos1:'CM',pos2:'CB'},
    {name:'ì„ ìš°',pos1:'RW',pos2:'RB'},
  ];
  document.getElementById('player-list').innerHTML = '';
  SAMPLE.forEach(s=>createPlayerRow({name:s.name,pos1:s.pos1,pos2:s.pos2||''}));
}
function clearAll(){ document.getElementById('player-list').innerHTML=''; document.getElementById('result').innerHTML=''; localStorage.removeItem('ad_shown'); document.getElementById('warning').style.display='none'; }

/* ì´ˆê¸° ìƒ˜í”Œ ë¡œë“œ */
loadSample();

/* ---------- í—¬í¼: UI -> ì„ ìˆ˜ ëª©ë¡ ì½ê¸° ---------- */
function readPlayers(){
  const rows = Array.from(document.querySelectorAll('.player-row'));
  const out = [];
  for(const r of rows){
    const name = r.querySelector('.pname').value.trim();
    const pos1 = r.querySelector('.ppos1').value;
    const pos2 = r.querySelector('.ppos2').value;
    if(!name || !pos1) continue; // ì´ë¦„ê³¼ 1ìˆœìœ„ëŠ” í•„ìˆ˜
    out.push({ name, pos1, pos2:pos2||'', assigned:0, lastQ:-5, consec:0 });
  }
  return out;
}

/* ---------- ëª©í‘œ íƒ€ê²Ÿ ê³„ì‚° (í•„ë“œ í”Œë ˆì´ì–´ ëŒ€ìƒ) ---------- */
function computeTargets(fieldPlayers){
  const M = fieldPlayers.length;
  if(M === 0) return {};
  // feasible: 2*M <= 40 <= 3*M
  if(2*M <= TOTAL_FIELD_SLOTS && TOTAL_FIELD_SLOTS <= 3*M){
    const targets = {};
    fieldPlayers.forEach(p=>targets[p.name]=2);
    let rem = TOTAL_FIELD_SLOTS - 2*M; // 0..M
    // ë¶„ë°°: ëœë¤ì„±ì„ ì„ë˜ ê³µí‰í•˜ê²Œ
    const order = [...fieldPlayers].sort(()=>Math.random()-0.5);
    let idx = 0;
    while(rem>0){
      if(targets[order[idx].name] < 3){ targets[order[idx].name]++; rem--; }
      idx = (idx+1)%order.length;
    }
    return targets;
  } else {
    // ë¶ˆê°€í”¼: floor/ceil ë¶„ë°°
    const base = Math.floor(TOTAL_FIELD_SLOTS / M);
    const extra = TOTAL_FIELD_SLOTS - base * M; // 0..M-1
    const order = [...fieldPlayers].sort(()=>Math.random()-0.5);
    const out = {};
    for(let i=0;i<M;i++) out[order[i].name] = base + (i < extra ? 1 : 0);
    // show warning to user
    const warn = document.getElementById('warning');
    warn.style.display='block';
    warn.textContent = `âš ï¸ í˜„ì¬ ì„ ìˆ˜ìˆ˜(${M+1}ëª…, GK í¬í•¨)ê°€ 'ëª¨ë“  ì„ ìˆ˜ 2~3ì¿¼í„°' ìš”êµ¬ì¡°ê±´ì„ ë§Œì¡±í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ëŒ€ì‹  ${base}~${base+1}ì¿¼í„°ë¡œ ê³µí‰í•˜ê²Œ ë¶„ë°°í–ˆìŠµë‹ˆë‹¤.`;
    return out;
  }
}

/* ---------- í¬ì§€ì…˜ ë§¤ì¹­: 1ìˆœìœ„ ìš°ì„ , 2ìˆœìœ„, í˜¸í™˜ í¬ì§€ì…˜ ---------- */
function isMatching(player, position){
  // primary exact match -> true
  if(player.pos1 === position) return 1; // score 1 (best)
  if(player.pos2 === position && player.pos2) return 2; // score 2
  // check compatible mapping for primary and secondary (directional)
  const comp1 = COMPATIBLE[player.pos1] || [];
  const comp2 = COMPATIBLE[player.pos2] || [];
  if(comp1.includes(position)) return 3; // compatible by primary
  if(comp2.includes(position)) return 4; // compatible by secondary
  return 999; // no match
}

/* ---------- í›„ë³´ ì„ íƒ: í¬ì§€ì…˜, q, targets, chosenThisQuarter ê¸°ì¤€ ---------- */
function pickCandidate(position, pool, q, targets, chosenThisQuarter){
  // filter by cannot exceed target & not used this quarter & not violate consec
  const canPick = p => {
    if(p.assigned >= targets[p.name]) return false;
    if(chosenThisQuarter.has(p.name)) return false;
    // 3ì¿¼í„° ì—°ì† ê¸ˆì§€
    if(p.lastQ === q-1 && p.consec >= MAX_CONSEC) return false;
    return true;
  };

  // 1) pos1 exact
  let list = pool.filter(p => canPick(p) && p.pos1 === position);
  if(list.length) return list.sort((a,b)=>a.assigned - b.assigned)[0];

  // 2) pos2 exact
  list = pool.filter(p => canPick(p) && p.pos2 === position && p.pos2);
  if(list.length) return list.sort((a,b)=>a.assigned - b.assigned)[0];

  // 3) compatible via primary
  list = pool.filter(p => canPick(p) && (COMPATIBLE[p.pos1]||[]).includes(position));
  if(list.length) return list.sort((a,b)=>a.assigned - b.assigned)[0];

  // 4) compatible via secondary
  list = pool.filter(p => canPick(p) && (COMPATIBLE[p.pos2]||[]).includes(position));
  if(list.length) return list.sort((a,b)=>a.assigned - b.assigned)[0];

  // 5) fallback: anyone who still needs slots (to fill)
  list = pool.filter(p => canPick(p));
  if(list.length) return list.sort((a,b)=>a.assigned - b.assigned)[0];

  return null;
}

/* ---------- ë‹¨ì¼ ì‹œë„: ëœë¤ì„± í¬í•¨, í•œ ë²ˆì˜ ì „ì²´ 4ì¿¼í„° ë°°ì • ì‹œë„ ---------- */
function attemptOnce(allPlayers, targets){
  // clone player states (shallow copy of objects)
  const pool = allPlayers.map(p=>({...p, assigned:0, lastQ:-5, consec:0}));
  // find GK (pos1 priority then pos2)
  const gk = pool.find(p=>p.pos1==='GK') || pool.find(p=>p.pos2==='GK');
  if(!gk) return null; // no GK -> fail
  // reserve GK: assigned 4 (but we still let targets map only for field players)
  gk.assigned = 4;
  gk.lastQ = -5;
  gk.consec = 0;
  // Prepare quarters
  const quarters = [[],[],[],[]];

  // For each quarter
  for(let q=0;q<4;q++){
    const chosenThisQuarter = new Set();
    // add GK at first slot
    quarters[q].push({pos:'GK', name:gk.name});
    // for remaining positions: iterate through POSITIONS from index 1
    for(let i=1;i<POSITIONS.length;i++){
      const pos = POSITIONS[i];
      // shuffle pool order for randomness while retaining deterministic selection by sort below
      // candidate selection uses pool array but pickCandidate sorts by assigned
      // call pickCandidate
      const candidate = pickCandidate(pos, pool, q, targets, chosenThisQuarter);
      if(!candidate){
        return null; // fail attempt
      }
      // assign
      quarters[q].push({pos, name:candidate.name});
      candidate.assigned++;
      // update consec & lastQ
      if(candidate.lastQ === q-1) candidate.consec = candidate.consec + 1;
      else candidate.consec = 1;
      candidate.lastQ = q;
      chosenThisQuarter.add(candidate.name);
    }
  }

  // Validate: all non-GK players met their targets exactly
  const unmet = pool.filter(p => p.name !== gk.name && p.assigned !== targets[p.name]);
  if(unmet.length) return null;

  // Validate: no player exceeded MAX_CONSEC anywhere (should be guaranteed)
  // Compute score: prefer pos1 matches (3), pos2 (2), compatible(1)
  let score = 0;
  quarters.forEach(qarr=>{
    qarr.forEach(entry=>{
      if(entry.pos === 'GK'){ score += 2; return; }
      const orig = allPlayers.find(x=>x.name===entry.name);
      if(!orig) return;
      if(orig.pos1 === entry.pos) score += 3;
      else if(orig.pos2 === entry.pos) score += 2;
      else if((COMPATIBLE[orig.pos1]||[]).includes(entry.pos) || (COMPATIBLE[orig.pos2]||[]).includes(entry.pos)) score += 1;
    });
  });

  // Build counts map
  const counts = Object.fromEntries(pool.map(p=>[p.name,p.assigned]));
  return {quarters, score, counts};
}

/* ---------- ë©”ì¸: ìŠ¤ì¼€ì¤„ ìƒì„± (ì—¬ëŸ¬ ì‹œë„ í›„ ìµœì  ì„ íƒ) ---------- */
let lastBest = null; // keep last best to show after regenerate
function generateSchedule(){
  document.getElementById('warning').style.display='none';
  const all = readPlayers();
  if(all.length < 11){ alert('ì„ ìˆ˜ëŠ” ìµœì†Œ 11ëª… ì´ìƒ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤ (GK í¬í•¨).'); return; }
  // ensure GK exists
  const gkCheck = all.find(p=>p.pos1==='GK') || all.find(p=>p.pos2==='GK');
  if(!gkCheck){ alert('ê³¨í‚¤í¼(GK)ë¥¼ 1ëª… ì´ìƒ ì§€ì •í•´ ì£¼ì„¸ìš” (pos1 ë˜ëŠ” pos2).'); return; }

  // field players for target calc: exclude selected GK (the one with pos1==='GK' first)
  const chosenGK = all.find(p=>p.pos1==='GK') || all.find(p=>p.pos2==='GK');
  const fieldPlayers = all.filter(p=>p.name !== chosenGK.name);

  // compute targets
  const targets = computeTargets(fieldPlayers);
  // ensure targets contains all field players
  // For safety, if fieldPlayers empty -> abort
  if(fieldPlayers.length === 0){ alert('í•„ë“œ ì„ ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤. GK ì œì™¸ ìµœì†Œ 10ëª… í•„ìš”.'); return; }

  // attempt scheduling multiple times
  const ATTEMPTS = Math.max(50, Math.min(5000, parseInt(document.getElementById('attempts').value)||400));
  let best = null;
  for(let i=0;i<ATTEMPTS;i++){
    const attempt = attemptOnce(all, targets);
    if(attempt && (!best || attempt.score > best.score)){
      best = attempt;
      // small early exit if score is very high (heuristic)
      // theoretical max score ~ (4quarters * 11slots * 3) but that's not necessary to hit
      if(best.score >= 4*10*3 + 2*4) break;
    }
  }

  if(!best){
    // if failed, suggest reasons & show guidance
    const msg = `âš ï¸ ìœ íš¨í•œ ë°°ì •ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.\nê°€ëŠ¥ ì›ì¸:\n`+
      `â€¢ í¬ì§€ì…˜ë³„ ì¸ì› ë¶ˆê· í˜• (ì˜ˆ: ê³µê²©ìˆ˜ ë¶€ì¡± ë“±)\n`+
      `â€¢ 'ëª¨ë“  ì„ ìˆ˜ 2~3ì¿¼í„°' ì¡°ê±´ì„ ë§Œì¡±í•˜ì§€ ì•ŠëŠ” ì„ ìˆ˜ìˆ˜\n`+
      `í•´ê²°: ì„ ìˆ˜ í¬ì§€ì…˜ì„ ì¡°ì •í•˜ê±°ë‚˜ 'ì‹œë„ ìˆ˜'ë¥¼ ëŠ˜ë ¤ë³´ì„¸ìš”.`;
    document.getElementById('result').innerText = msg;
    return;
  }

  lastBest = best;
  renderResult(best.quarters, best.counts, best.score);
  // show ad (first-time only)
  showAdOnce();
}

/* ---------- ì¬ì‹œë„: ë‹¤ì‹œ ì‹œë„(ìƒˆ ë‚œìˆ˜ ë°°ì •) ---------- */
function regenerate(){
  if(!lastBest){ generateSchedule(); return; }
  const all = readPlayers();
  if(all.length < 11){ alert('ì„ ìˆ˜ ì…ë ¥ì„ í™•ì¸í•˜ì„¸ìš”.'); return; }
  const fieldPlayers = all.filter(p=>!(p.pos1==='GK' || p.pos2==='GK' || all.find(x=>x.pos1==='GK' || x.pos2==='GK')?.name === p.name));
  const targets = computeTargets(fieldPlayers);
  const ATTEMPTS = Math.max(50, Math.min(5000, parseInt(document.getElementById('attempts').value)||400));
  let best = null;
  for(let i=0;i<ATTEMPTS;i++){
    const attempt = attemptOnce(all, targets);
    if(attempt && (!best || attempt.score > best.score)) best = attempt;
  }
  if(!best){ alert('ìƒˆ ì¡°í•©ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì„ ìˆ˜ìˆ˜/í¬ì§€ì…˜ì„ ì¡°ì •í•˜ê±°ë‚˜ ì‹œë„ ìˆ˜ë¥¼ ëŠ˜ë¦¬ì„¸ìš”.'); return; }
  if(!lastBest || best.score >= lastBest.score){
    lastBest = best;
  }
  renderResult(lastBest.quarters, lastBest.counts, lastBest.score);
}

/* ---------- ë Œë”ë§ ---------- */
function renderResult(quarters, counts, score){
  const out = document.getElementById('result');
  let html = `<div class="panel"><strong>ìµœì  ì ìˆ˜:</strong> ${score} <span class="small"> (ì ìˆ˜ ë†’ì„ìˆ˜ë¡ 1ìˆœìœ„/2ìˆœìœ„ ìš°ì„  ë°˜ì˜)</span></div>`;
  // quarters display
  quarters.forEach((qarr, idx)=>{
    html += `<div class="quarter"><h3>ğŸ•’ ${idx+1}ì¿¼í„°</h3><table class="table"><tr><th>í¬ì§€ì…˜</th><th>ì„ ìˆ˜</th></tr>`;
    qarr.forEach(entry=> html += `<tr><td>${entry.pos}</td><td>${entry.name}</td></tr>`);
    html += `</table></div>`;
  });

  // summary table
  html += `<div class="panel"><h3>âš–ï¸ ì¶œì „ ì¿¼í„° ìš”ì•½ (ì´ ìŠ¬ë¡¯: GK4 + í•„ë“œ${TOTAL_FIELD_SLOTS} = ${TOTAL_FIELD_SLOTS+4})</h3>`;
  html += `<table class="table"><tr><th>ì´ë¦„</th><th>ì¿¼í„° ìˆ˜</th><th>ê·¸ë˜í”„</th></tr>`;
  const sorted = Object.keys(counts).sort((a,b)=>counts[b]-counts[a]||a.localeCompare(b));
  sorted.forEach(name=>{
    const c = counts[name]||0;
    const pct = Math.round((c/4)*100);
    html += `<tr><td>${name}</td><td>${c}</td><td><div class="bar-bg"><div class="bar" data-w="${pct}%"></div></div></td></tr>`;
  });
  html += `</table></div>`;
  out.innerHTML = html;

  // animate bars
  setTimeout(()=> {
    document.querySelectorAll('.bar').forEach(b=>{
      const w = b.getAttribute('data-w') || '0%';
      b.style.width = w;
    });
  },50);
}

/* ---------- ë‚´ë³´ë‚´ê¸° ---------- */
function exportTxt(){
  if(!lastBest){ alert('ë¨¼ì € í¬ë©”ì´ì…˜ ìƒì„±í›„ ë‚´ë³´ë‚´ê¸° í•˜ì„¸ìš”.'); return; }
  let txt = `í¬ë©”ì´ì…˜ ìë™ ë°°ì • ê²°ê³¼\nìµœì  ì ìˆ˜: ${lastBest.score}\n\n`;
  lastBest.quarters.forEach((q,i)=>{
    txt += `${i+1}ì¿¼í„°\n`;
    q.forEach(e=> txt += `${e.pos}: ${e.name}\n`);
    txt += `\n`;
  });
  const blob = new Blob([txt],{type:'text/plain;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'formation_result.txt';
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}

/* ---------- ê´‘ê³  íŒì—…: ìµœì´ˆ 1íšŒ ìë™ í‘œì‹œ ---------- */
function showAdOnce(){
  if(localStorage.getItem('ad_shown')) return;
  const ad = document.getElementById('ad-popup');
  ad.style.display='block';
  localStorage.setItem('ad_shown','1');
}
function hideAd(){ document.getElementById('ad-popup').style.display='none'; }

/* ---------- ì´ˆê¸° ë„ì›€ë§ (ê²½ê³  ë“±) ---------- */
/* No extra action needed. The computeTargets() shows a warning when targets are infeasible. */

</script>
</body>
</html>
